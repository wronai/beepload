# Global settings
{
    # Auto HTTPS configuration
    email admin@example.com
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# ============ PUBLIC UPLOAD FRONTEND ============
{$FRONTEND_DOMAIN} {
    # Redirect HTTP to HTTPS
    redir https://{$FRONTEND_DOMAIN}{uri}
}

https://{$FRONTEND_DOMAIN} {
    # Reverse proxy to frontend service
    reverse_proxy frontend:3000
}

# ============ MANAGER DASHBOARD ============
{$MANAGER_DOMAIN} {
    redir https://{$MANAGER_DOMAIN}{uri}
}

https://{$MANAGER_DOMAIN} {
    # Authentication middleware
    @manager path /manager/*
    handle @manager {
        # Add authentication check
        reverse_proxy manager-frontend:3001
    }
    
    # Fallback
    handle {
        reverse_proxy manager-frontend:3001
    }
}

# ============ ADMIN DASHBOARD ============
{$ADMIN_DOMAIN} {
    redir https://{$ADMIN_DOMAIN}{uri}
}

https://{$ADMIN_DOMAIN} {
    # Authentication middleware
    @admin path /admin/*
    handle @admin {
        # Add authentication check
        reverse_proxy admin-frontend:3002
    }
    
    # Fallback
    handle {
        reverse_proxy admin-frontend:3002
    }
}

# ============ API ENDPOINTS ============
{$API_DOMAIN} {
    # Public upload endpoint - no auth required
    route /uploads {
        reverse_proxy upload-service:3000
    }
    
    # Approval endpoints - require auth
    route /approve/* {
        # Add authentication middleware
        reverse_proxy approval-service:8080
    }
    
    # Config endpoints - require admin auth
    route /config/* {
        # Add admin authentication middleware
        reverse_proxy config-service:5000
    }
    
    # Notification endpoints - internal use only
    route /notifications/* {
        reverse_proxy notification-service:3001
    }
}

# ============ AUTHENTICATION ============
{$AUTH_DOMAIN} {
    # Kratos self-service endpoints
    route /self-service/* {
        reverse_proxy kratos:4433 {
            transport http {
                tls_insecure_skip_verify
            }
        }
    }
    
    # Kratos admin endpoints
    route /admin/* {
        reverse_proxy kratos:4434 {
            transport http {
                tls_insecure_skip_verify
            }
        }
    }
}

# ============ WEBDAV STORAGE ============
{$WEBDAV_DOMAIN} {
    # Basic authentication for WebDAV
    basicauth {
        {$WEBDAV_USER} {$WEBDAV_PASSWORD_HASH}
    }
    
    # WebDAV configuration
    root * /storage
    file_server browse
    
    # Enable WebDAV methods
    @dav_methods method PUT DELETE MKCOL COPY MOVE
    handle @dav_methods {
        reverse_proxy webdav:80
    }
}
